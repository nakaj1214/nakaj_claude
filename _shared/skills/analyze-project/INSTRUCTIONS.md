# プロジェクト解析 → Rules / Skills 自動生成ガイド

既存プロジェクトのコードを読み込み、コーディング規約・命名規則・アーキテクチャを抽出して
`rules/` と `skills/` ファイルを自動生成する手順。

---

## フェーズ 1: 情報収集

### 1-1. プロジェクトパスの確認

ユーザーにプロジェクトのパスを確認する。指定がなければ現在の作業ディレクトリを使用。

### 1-2. ディレクトリ構造の把握

```bash
# トップレベルの構造（深さ 3 まで）
find <project_path> -maxdepth 3 \
  -not -path '*/node_modules/*' \
  -not -path '*/.git/*' \
  -not -path '*/vendor/*' \
  -not -path '*/__pycache__/*' \
  -not -path '*/dist/*' \
  -not -path '*/build/*' \
  | sort
```

把握する内容:
- フォルダ構成（MVC / レイヤードアーキテクチャ / ドメイン分割 等）
- 使用言語（拡張子から判断）
- フレームワーク（`composer.json`, `package.json`, `requirements.txt`, `platformio.ini` 等）

### 1-3. 既存の規約定義ファイルを読む（優先度: 高）

以下が存在すれば必ず読む：

| ファイル | 内容 |
|---|---|
| `.editorconfig` | インデント・改行コード |
| `.eslintrc.*` / `eslint.config.*` | JS/TS リントルール |
| `.phpcs.xml` / `phpstan.neon` | PHP 静的解析設定 |
| `pyproject.toml` / `setup.cfg` | Python フォーマット設定 |
| `CONTRIBUTING.md` / `DEVELOPMENT.md` | 開発参加ガイド |
| `README.md` | プロジェクト概要・セットアップ手順 |
| `.env.example` | 環境変数の種類（値は読まない） |
| `Makefile` / `justfile` | よく使うコマンド定義 |
| `docker-compose.yml` | サービス構成 |

### 1-4. ソースコードのサンプリング

各カテゴリから **2〜3 ファイル** を選んで読む：

```
優先して読むファイル:
- モデル / エンティティ クラス        → 命名規則・プロパティ定義方法
- コントローラー / ハンドラー          → メソッド命名・引数・戻り値の型
- サービス / ユースケース クラス       → ビジネスロジックのパターン
- テストファイル                       → テスト構造・アサーション方法
- ユーティリティ / ヘルパー            → 共通処理のパターン
- 設定ファイル（config/*, settings.*） → 環境別設定の扱い方
```

**読まないもの（機密・無関係）:**
- `.env`, `.env.*`（環境変数の値）
- `*.key`, `*.pem`, `*secret*`, `*password*`
- `node_modules/`, `vendor/`, `dist/`, `build/`
- バイナリファイル（画像・PDF 等）

---

## フェーズ 2: パターン抽出

読んだコードから以下を分析する。

### 2-1. 命名規則チェックリスト

```
[ ] ファイル名: snake_case / PascalCase / kebab-case / camelCase？
[ ] クラス名: PascalCase？ サフィックスのパターン（Controller, Service, Repository 等）？
[ ] メソッド名: camelCase / snake_case？ 動詞の使い方（get/fetch/find の使い分け等）？
[ ] 変数名: camelCase / snake_case？ プレフィックス（$, _, is, has 等）？
[ ] 定数: UPPER_SNAKE_CASE？
[ ] DB テーブル名: snake_case_plural？
[ ] API ルートパス: /kebab-case / /snake_case / /camelCase？
[ ] テストファイル: *Test.php / *.test.ts / test_*.py？
```

### 2-2. コードスタイルチェックリスト

```
[ ] インデント: スペース（何個？）/ タブ？
[ ] クォート: シングル / ダブル？
[ ] セミコロン: あり / なし？
[ ] 末尾カンマ: あり / なし？
[ ] 型アノテーション: 必須 / 任意 / なし？
[ ] コメント: JSDoc / PHPDoc / docstring / インラインのみ？
[ ] early return パターンを使っているか？
[ ] アロー関数 vs 通常関数の使い分け？
```

### 2-3. アーキテクチャパターンの把握

```
[ ] ディレクトリ構成の方針
    - MVC（Model/View/Controller）
    - レイヤード（Controller → Service → Repository）
    - ドメイン駆動（domain/usecase/infrastructure）
    - Feature/モジュール分割

[ ] 依存性注入の使い方
[ ] エラーハンドリングの方針（例外 vs 戻り値）
[ ] 非同期処理のパターン（async/await / Promise / callback）
[ ] 状態管理のパターン（フロントエンドの場合）
```

### 2-4. プロジェクト固有ドメインの把握

```
[ ] 主要なエンティティ名（User, Order, Product 等）
[ ] 専門用語・略語（社内用語、ドメイン固有語）
[ ] よく使う処理フロー（認証フロー、データ登録フロー等）
[ ] 特殊な制約（文字数制限・バリデーションルール等）
```

---

## フェーズ 3: 出力ファイルの生成

### 3-1. 生成するファイルの判断基準

| 条件 | 生成するもの |
|---|---|
| 命名規則・スタイルが確認できた | `rules/<言語>/conventions.md` |
| フレームワーク固有の規約がある | `rules/<フレームワーク>/conventions.md` |
| 繰り返し行う特定の作業がある | `skills/<作業名>/` |
| 特殊なデプロイ・ビルド手順がある | `skills/<作業名>/` |

### 3-2. rules ファイルの構成テンプレート

```markdown
# <プロジェクト名> / <言語> コーディング規約

<プロジェクト概要を1〜2文で>
（解析日: YYYY-MM-DD）

---

## 命名規則

### ファイル名
- <観察したパターン>

### クラス名
- <観察したパターン>

### メソッド・関数名
- <観察したパターン>

### 変数・プロパティ名
- <観察したパターン>

---

## コードスタイル

- インデント: <スペースN個 / タブ>
- クォート: <シングル / ダブル>
- <他に観察したルール>

---

## アーキテクチャ規約

### ディレクトリ構成
<観察した構成パターン>

### 処理の流れ
<観察した依存関係・フロー>

---

## よく使うパターン

<プロジェクト固有の実装パターンをコード例付きで記載>

---

## 禁止パターン

<コードで見かけた「やってはいけない」パターン>

---

## 注意事項

> ⚠️ このファイルはコード解析から自動生成されました。
> 実際の運用では開発チームのレビューを経て確定させてください。
```

### 3-3. skills ファイルの判断基準

以下が見つかった場合にスキルを作成する：

- `Makefile` や `README.md` に繰り返し手順が書いてある
- 特定のコマンド群がセットで使われている（例：マイグレーション → シードの流れ）
- ドメイン固有の作業フロー（例：帳票生成、バッチ処理の実行手順）
- デプロイ・テスト・ビルドの手順

---

## フェーズ 4: ユーザーへの確認と調整

### 4-1. 生成後の報告フォーマット

```
## 解析結果レポート

### 検出された技術スタック
- 言語: ...
- フレームワーク: ...
- テストフレームワーク: ...

### 生成したファイル
- rules/xxx/conventions.md  → 命名規則・コードスタイル
- skills/xxx/              → <説明>

### 確信度が低い項目（要確認）
- □ <観察できなかった / 少数サンプルのみ確認した項目>

### 読まなかったもの（プロジェクトに存在しなかった）
- ...
```

### 4-2. ユーザーへの確認事項

生成後に以下を確認する：

1. **追加で読んでほしいファイルはあるか** — サンプリングで漏れた重要ファイル
2. **社内用語・ドメイン用語で補足したいものはあるか** — 略語・専門語の定義
3. **特に守ってほしいルールで未反映のものはあるか** — 口頭伝承のルール等
4. **削除・修正したい内容はあるか** — 古いパターン・例外扱いのコード

---

## 出力先の決め方

### _shared に追加する場合（複数プロジェクトに適用したい汎用ルール）

```
_shared/rules/<言語 or フレームワーク>/conventions.md
_shared/skills/<作業名>/
```

### プロジェクト専用の場合

```
<project>/.claude/rules/<名前>.md
<project>/.claude/skills/<作業名>/
```

**判断基準:**
- 他のプロジェクトでも使えそう → `_shared/`
- このプロジェクト固有の手順・ドメイン → `.claude/` 以下

---

## 実行チェックリスト

- [ ] プロジェクトパスを確認した
- [ ] 既存の規約ファイル（.editorconfig, eslintrc 等）を読んだ
- [ ] 各カテゴリから 2〜3 ファイルをサンプリングして読んだ
- [ ] `.env` や機密ファイルを読んでいない
- [ ] 命名規則・スタイル・アーキテクチャの3軸で分析した
- [ ] rules ファイルを生成した
- [ ] 必要に応じて skills ファイルを生成した
- [ ] 確信度が低い項目をユーザーに確認した
- [ ] ファイル末尾に「自動生成である旨」の注釈を入れた
