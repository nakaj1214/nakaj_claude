# Handover — 詳細手順

セッションの内容を次の Claude セッションへ引き継ぐためのドキュメントを生成する。
コンテキストが圧迫されたとき、またはセッション終了時に自動的に呼び出される。

---

## 出力先

```
.claude/docs/memory/HANDOVER_YYYYMMDD_HHMMSS.md
```

ディレクトリが存在しない場合は作成する:
```bash
mkdir -p .claude/docs/memory
```

---

## 生成手順

### 1. 現在のセッションを振り返る

会話履歴・実行したツール・編集したファイルを確認し、以下を把握する:

- 何のタスクに取り組んでいたか
- どこまで完了したか
- 何が未完了か
- 発生した問題と解決策
- 下した重要な判断

### 2. HANDOVER.md を生成する

以下のテンプレートで `.claude/docs/memory/HANDOVER_YYYYMMDD_HHMMSS.md` を作成する:

```markdown
# Handover — {日時}

## セッション概要

{1〜3文でこのセッションの目的と結果を要約}

---

## 完了した作業

- {完了したタスク1}
- {完了したタスク2}
- ...

## 未完了の作業

- [ ] {未完了タスク1} — {現在の状況・次のステップ}
- [ ] {未完了タスク2} — {現在の状況・次のステップ}

---

## 判断・決定事項

| 判断内容 | 理由 |
|---------|------|
| {決定1} | {なぜそうしたか} |
| {決定2} | {なぜそうしたか} |

---

## 発生した問題と解決策

### {問題1のタイトル}

**問題:** {何が起きたか}
**解決策:** {どう解決したか}
**注意点:** {次回への教訓}

---

## 注意点・落とし穴

- {気をつけるべき点1}
- {気をつけるべき点2}

---

## 次のステップ

1. {最優先タスク}
2. {次にすること}
3. {その後}

---

## 重要ファイルマップ

| ファイル | 役割 | 状態 |
|---------|------|------|
| {ファイルパス} | {何をするファイル} | {変更済み/新規/確認済み} |

---

## コンテキスト情報

- **作業ディレクトリ:** {カレントディレクトリ}
- **関連ブランチ:** {git ブランチ名（あれば）}
- **セッション終了理由:** {コンテキスト圧迫 / 手動 / タスク完了}
```

### 3. 保存を確認する

ファイルが作成されたことを確認し、ユーザーに伝える:
```
✅ ハンドオーバードキュメントを保存しました:
   .claude/docs/memory/HANDOVER_{timestamp}.md
```

---

## 品質チェック

生成前に以下を確認:

- [ ] 未完了タスクが明確に記載されているか
- [ ] 次のステップが具体的か（抽象的な「確認する」ではなく「○○ファイルの△△を修正する」）
- [ ] 重要な判断理由が残されているか
- [ ] ファイルマップに変更したファイルが全て含まれているか
- [ ] 次のセッションで即座に作業再開できる情報が揃っているか

---

## 自動実行について

`pre-compact-handover.py` フックによって、Claude Code が**自動コンパクション**を実行する直前に自動的に起動される。

- **フックイベント:** `PreCompact`（matcher: `"auto"`）
- **タイミング:** 自動圧縮の直前 — 会話履歴が intact なうちに読み込める
- **除外:** 手動 `/compact` では発火しない
- **処理:** `claude -p` がトランスクリプト全体を読んで要約を生成し保存

フックの登録は `settings.json` の `hooks.PreCompact` セクションで行う（[登録方法](_shared/hooks/pre-compact-handover.py) のファイル冒頭コメント参照）。
