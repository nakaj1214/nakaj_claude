---
name: debug
description: 体系的デバッグ - 4段階の原因分析プロセスで確実にバグを解決する。勘ではなく証拠重視。
---

# 体系的デバッグ スキル

勘や推測ではなく、証拠に基づいて原因を特定・解決するための4段階プロセス。

## 使う場面

1. バグ原因が不明なとき
2. 修正しても再発するバグ
3. 複雑な相互作用が疑われるとき
4. 「とにかく動かない」状態のとき

## 4段階プロセス

### ステージ1: 症状の収集

**目的:** 問題を正確に理解する

```markdown
## 症状記録

### 観測された挙動
- 何が起きているか（具体的に）
- エラーメッセージ（全文）
- 発生条件（いつ、どこで）

### 期待される挙動
- 何が起きるべきか
- 仕様やドキュメントへの参照

### 再現手順
1. Step 1
2. Step 2
3. ...

### 環境情報
- OS / Runtimeバージョン
- 依存関係バージョン
- 設定ファイル
```

**重要:** この段階では仮説を立てない。観測のみ。

### ステージ2: 仮説の生成

**目的:** 可能性のある原因を網羅的に列挙

```markdown
## 仮説一覧

| # | 仮説 | 可能性 | 検証方法 |
|---|------------|-------------|---------------------|
| 1 | [原因候補A] | High/Med/Low | [検証方法] |
| 2 | [原因候補B] | High/Med/Low | [検証方法] |
| 3 | [原因候補C] | High/Med/Low | [検証方法] |
```

**仮説生成のヒント:**
- 最近変更したコード
- 外部依存（API、DB、ファイル）
- 環境差異（dev vs prod）
- タイミング/レース条件
- データ境界条件

### ステージ3: 仮説検証

**目的:** 各仮説を証拠で確認/否定する

```markdown
## 検証結果

### 仮説1: [仮説内容]
- 検証方法: [何をしたか]
- 結果: [観測事実]
- 判断: 確認 / 否定 / 要追加検証
- 証拠: [ログ、スクリーンショット等]

### 仮説2: [仮説内容]
...
```

**検証テクニック:**
- ログ出力を追加
- ブレークポイントで変数確認
- 最小再現コード作成
- 二分探索（bisect）
- 環境差分比較

### ステージ4: 修正と検証

**目的:** 原因を修正し、再発を防ぐ

```markdown
## 修正

### 根本原因
[特定した原因の説明]

### 修正内容
- File: [パス]
- Change: [何をどう変えたか]

### 検証
- [ ] 元のバグが解消
- [ ] 関連機能が壊れていない
- [ ] エッジケースを確認
- [ ] テスト追加

### 再発防止
- [ ] なぜ起きたか理解した
- [ ] 類似バグ防止策を検討した
```

## 実践例

### 例: API呼び出しが時々失敗する

**ステージ1: 症状の収集**
```
- 挙動: APIが約10回に1回失敗
- エラー: "Connection reset by peer"
- 条件: 高負荷時に多い
- 環境: 本番のみ
```

**ステージ2: 仮説生成**
```
1. 接続プール枯渇 (High)
2. タイムアウト設定が短い (Medium)
3. サーバー側の問題 (Medium)
4. ネットワーク不安定 (Low)
```

**ステージ3: 検証**
```
仮説1: 接続プール
- 検証: プール使用状況をログ
- 結果: 高負荷で枯渇
- 判断: 確認
```

**ステージ4: 修正**
```
- プールサイズを増やす
- 接続の適切なクローズ
- 監視アラートを追加
```

## アンチパターン

### やってはいけないこと

| アンチパターン | 問題 | 代わりにやること |
|--------------|---------|-----------------|
| 推測で修正 | 根本原因を見逃す | 修正前に仮説検証 |
| 複数修正を同時に実施 | 何が効いたか不明 | 1つずつ変更して検証 |
| ログを消す | 証拠が残らない | 解析用ログを保持 |
| 再現を諦める | 根本解決できない | 再現条件を特定する |

### 良いデバッグの兆候

- 「なぜ」を5回問う
- 証拠に基づいて判断
- 変更前後を比較
- 再発防止を考える

## デバッグツール

### ログ解析
```bash
# パターン検索
grep -n "ERROR" app.log | head -20

# 時間帯フィルタ
awk '/2024-01-25 10:0[0-5]/' app.log
```

### Git bisect
```bash
# バグを導入したコミットを特定
git bisect start
git bisect bad          # 現在はバグあり
git bisect good v1.0.0  # このバージョンは正常
# 二分探索で特定
```

### 最小再現
```
1. 新規プロジェクトを作成
2. 必要最小のコードをコピー
3. 再現するまで追加
4. 再現したら原因特定
```

## チェックリスト

```markdown
## デバッグチェックリスト

### 準備
- [ ] 問題を再現できる
- [ ] エラーメッセージを記録
- [ ] 環境情報を確認

### 分析
- [ ] 仮説を3つ以上作成
- [ ] 各仮説の検証方法を決めた
- [ ] 証拠に基づいて判断した

### 修正
- [ ] 根本原因を特定
- [ ] 修正で問題が解消
- [ ] 副作用がないことを確認
- [ ] テストを追加

### 完了
- [ ] 再発防止を検討
- [ ] ドキュメント更新
```

## 関連スキル

- [tdd-workflow](tdd-workflow.md): テスト駆動開発でバグを防ぐ
- [code-review](code-review.md): レビューによる早期検出
