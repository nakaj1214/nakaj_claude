---
name: code-review
description: 品質・セキュリティ・パフォーマンス・ベストプラクティスに焦点を当てた包括的なコードレビュー。ユーザーがコードレビューや品質評価を求めたときに使用。
---

# コードレビュー スキル

業界標準、セキュリティ基準、パフォーマンス最適化の原則に沿って徹底的なコードレビューを行う。

## このスキルを使う場面

- ユーザーが明示的にコードレビューを依頼したとき
- コード品質の確認を求められたとき
- 大きな変更をマージする前
- プルリクエストの評価時
- 新機能の実装後

## レビュープロセス

### ステップ1: 文脈の理解
1. 対象ファイル/モジュール全体を読む
2. 目的とスコープを理解する
3. 依存関係や相互作用を把握する
4. 関連テストがあれば確認する

### ステップ2: セキュリティ分析
OWASP Top 10を念頭に確認する:

**インジェクション攻撃**
- SQL Injection: クエリはパラメータ化されているか
- Command Injection: ユーザー入力は適切にサニタイズされているか
- XSS: 出力は適切にエスケープされているか
- Path Traversal: ファイルパスは検証されているか

**認証・認可**
- 認証情報は適切に管理されているか
- 認証は正しく実装されているか
- 認可チェックは存在するか
- セッション管理は安全か

**データ保護**
- 機密データは暗号化されているか
- シークレットがハードコードされていないか
- 境界でデータ検証がされているか

**セキュリティ設定ミス**
- セキュリティヘッダーは設定されているか
- CORSは正しく設定されているか
- エラーメッセージに情報漏えいがないか

### ステップ3: コード品質
**可読性**
- 自己説明的なコードか
- 命名が明確で一貫しているか
- 複雑度は適切か
- 関数は単一責務か

**保守性**
- 重複コードはないか
- マジックナンバー/文字列はないか
- エラーハンドリングは十分か
- エッジケースを考慮しているか

**ベストプラクティス**
- 言語の慣習に従っているか
- 未使用の変数/インポートはないか
- 過剰設計になっていないか
- 不要な抽象化はないか

### ステップ4: パフォーマンス
**効率性**
- N+1クエリ問題がないか
- 大規模データにページネーションはあるか
- リソースは適切に解放されているか
- メモリリークはないか

**最適化**
- 高コスト処理をキャッシュできるか
- DBクエリは最適化されているか
- 適切に遅延ロードしているか
- アルゴリズムは効率的か

### ステップ5: テスト
**カバレッジ**
- テストはあるか
- エッジケースをテストしているか
- エラーパスをテストしているか
- テスト網羅性は十分か

**品質**
- テストは読みやすく保守可能か
- テストが挙動を正しく検証しているか
- テストは独立しているか

### ステップ6: アーキテクチャ
**設計**
- SOLID原則に従っているか
- 関心の分離が保たれているか
- 依存関係は適切に管理されているか
- テストしやすいか

**パターン**
- デザインパターンは適切に使われているか
- コードベースと整合したパターンか
- アンチパターンがないか

## レビュー出力フォーマット

以下の構成でフィードバックを出す:

```markdown
## コードレビューサマリー

**総合評価**: [簡潔な要約]
**重大度**: [Critical / High / Medium / Low]

## 重大な問題
[マージ前に必ず修正すべき問題]

1. **[Issue Title]** ([File:Line](path/file.ts#L123))
   - **問題**: [問題点]
   - **影響**: [セキュリティ/データ損失など]
   - **修正**: [修正方法]

## 重要な問題
[対応すべき問題]

1. **[Issue Title]** ([File:Line](path/file.ts#L123))
   - **問題**: [問題点]
   - **影響**: [性能/保守性など]
   - **提案**: [改善案]

## 改善提案
[あると良い改善]

1. **[Improvement Title]** ([File:Line](path/file.ts#L123))
   - **現状**: [現在の実装]
   - **提案**: [より良い方法]
   - **効果**: [理由]

## 良い点
[うまくできていること]

- Strength 1
- Strength 2

## チェックリスト
- [ ] セキュリティ脆弱性への対応
- [ ] コード品質基準の達成
- [ ] パフォーマンス最適化
- [ ] テストの十分性
- [ ] ドキュメント更新
```

## ガイドライン

- **具体的に**: ファイルと行番号を明示する
- **建設的に**: ただ批判せず改善案を出す
- **優先順位付け**: 重大なセキュリティ問題 → 品質 → スタイル
- **文脈重視**: 既存パターンを考慮する
- **細かすぎる指摘は避ける**: 意味のある改善に集中
- **徹底する**: ファイルやセクションを飛ばさない

## よくある落とし穴

- **過剰レビュー**: 既存パターンに沿った動作中のコードまで変えない
- **文脈不足**: 単体で判断せず、全体像を理解する
- **スタイル偏重**: 正確性・安全性を優先する
- **テスト軽視**: テストの網羅性と品質を必ず確認する

## セキュリティレビュー チェックリスト

### 入力検証
- [ ] すべてのユーザー入力が検証されている
- [ ] 入力長が制限されている
- [ ] 入力タイプが確認されている
- [ ] 特殊文字が適切に扱われている

### 出力エンコード
- [ ] HTML出力がエスケープされている
- [ ] SQLクエリがパラメータ化されている
- [ ] コマンド実行が回避/サニタイズされている
- [ ] URLが検証されている

### 認証
- [ ] パスワードがハッシュ化されている（bcrypt/argon2）
- [ ] セッショントークンが安全
- [ ] レート制限が実装されている
- [ ] 適切な場合にMFAがサポートされている

### 認可
- [ ] アクセス制御が強制されている
- [ ] リソース所有権が検証されている
- [ ] 特権昇格が防止されている
- [ ] APIエンドポイントが保護されている

### データ保護
- [ ] 機密データが保存時に暗号化されている
- [ ] 通信時にTLS/SSLが使用されている
- [ ] シークレットがコード内にない
- [ ] PIIが適切に扱われている

### エラーハンドリング
- [ ] エラーが情報を漏らさない
- [ ] スタックトレースが公開されていない
- [ ] ログが安全に管理されている
- [ ] 失敗時も穏当な挙動をする

## パフォーマンスレビュー チェックリスト

### データベース
- [ ] クエリにインデックスがある
- [ ] N+1クエリを回避している
- [ ] コネクションプールを使用している
- [ ] トランザクションのスコープが適切

### キャッシュ
- [ ] 高コスト処理をキャッシュしている
- [ ] キャッシュ無効化が正しい
- [ ] キャッシュキーが適切
- [ ] TTLが妥当

### リソース
- [ ] ファイルが適切に閉じられている
- [ ] 接続が解放されている
- [ ] メモリが管理されている
- [ ] バックグラウンドジョブがキュー化されている

## 例

### 例1: セキュリティレビュー
**ユーザー依頼:**
```
Review auth/login.ts for security issues
```

**回答例:**
```markdown
## コードレビューサマリー

**ファイル**: [auth/login.ts](auth/login.ts)
**総合評価**: 重大なセキュリティ問題が見つかりました
**重大度**: Critical

## 重大な問題

1. **パスワード未ハッシュ** ([auth/login.ts:45](auth/login.ts#L45))
   - **問題**: パスワードが平文で保存されている
   - **影響**: 漏えい時に全ユーザーのパスワードが露出する
   - **修正**: bcryptまたはargon2でハッシュ化する

[... 以降詳細が続く ...]
```

### 例2: 品質レビュー
**ユーザー依頼:**
```
Review the new feature in src/components/UserProfile.tsx
```

**回答例:**
```markdown
## コードレビューサマリー

**ファイル**: [src/components/UserProfile.tsx](src/components/UserProfile.tsx)
**総合評価**: 実装は良好だが小さな改善が必要
**重大度**: Low

## 重要な問題

1. **エラーハンドリング不足** ([UserProfile.tsx:78](src/components/UserProfile.tsx#L78))
   - **問題**: API呼び出しのエラー処理がない
   - **影響**: 失敗時のUXが悪化する
   - **提案**: try-catchとエラーステートを追加

[... 以降詳細が続く ...]
```

## 関連スキル

- [systematic-debugging](systematic-debugging.md): 体系的な原因究明プロセス
- [tdd-workflow](tdd-workflow.md): テスト駆動開発の進め方
- [brainstorming](brainstorming.md): 要件と設計の掘り下げ
